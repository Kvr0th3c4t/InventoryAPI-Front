@page "/"
@attribute [AuthorizeAttribute]
@inject IProductoStatsService ProductoStatsService
@inject IProveedorStatsService ProveedorStatsService
@inject IMovimientosStatsService MovimientosStatsService
@inject ICategoriaStatsService CategoriaStatsService

<PageTitle>Dashboard - Inventory Manager</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <MudPaper Elevation="0" Class="pa-4 mb-6" Style="border-left: 4px solid var(--mud-palette-primary);">
        <MudText Typo="Typo.h6" Color="Color.Primary">KPIs Principales</MudText>
    </MudPaper>

    <MudGrid Spacing="3" Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <KpiCard Title="Valor Total Inventario" Value=@($"{valorTotal:N2} €")
                Icon="@Icons.Material.Filled.AttachMoney" IconColor="Color.Success" ValueColor="Color.Success" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <KpiCard Title="Precio Promedio" Value=@($"{precioPromedio:N2} €") Icon="@Icons.Material.Filled.TrendingUp"
                IconColor="Color.Info" ValueColor="Color.Info" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <KpiCard Title="Total Productos" Value=@totalProductos.ToString("N0")
                Icon="@Icons.Material.Filled.Inventory" IconColor="Color.Primary" ValueColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <KpiCard Title="Stock Bajo" Value=@(stockBajo == 0 ? "Sin alertas" : stockBajo.ToString())
                Icon="@Icons.Material.Filled.Warning" IconColor="Color.Warning" ValueColor="Color.Warning" />
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border-left: 4px solid var(--mud-palette-info);">
        <MudText Typo="Typo.h6" Color="Color.Info">Resumen de Movimientos (Últimos 30 días)</MudText>
    </MudPaper>

    <MudGrid Spacing="3" Class="mb-6">
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="2" Class="pa-3">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.ShowChart" Class="mr-2" />
                        Movimientos por Día
                    </MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info">Últimos 30 días</MudChip>
                </MudStack>
                <MudChart ChartType="ChartType.Line" ChartSeries="@_series" XAxisLabels="@_xAxisLabels" Width="100%"
                    Height="288px" ChartOptions="@_options" />
            </MudPaper>
        </MudItem>

        <MudItem xs="12" lg="4">
            <MudStack Spacing="3">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.SwapVert" Color="Color.Tertiary" />
                            <MudText Typo="Typo.body2" Color="Color.Tertiary">Total Movimientos</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h5">
                            @(totalMovimientosUltimos30 == 0 ? "Sin movimientos" :
                                                        totalMovimientosUltimos30.ToString("N0"))
                        </MudText>
                    </MudStack>
                </MudPaper>

                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" Color="Color.Success" />
                            <MudText Typo="Typo.body2" Color="Color.Success">Entradas</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h5">
                            @(entradaVsSalidaUltimos30?.TotalEntradas ?? 0)
                        </MudText>
                    </MudStack>
                </MudPaper>

                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" Color="Color.Error" />
                            <MudText Typo="Typo.body2" Color="Color.Error">Salidas</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h5">
                            @(entradaVsSalidaUltimos30?.TotalSalidas ?? 0)
                        </MudText>
                    </MudStack>
                </MudPaper>

                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.RemoveCircle" Color="Color.Warning" />
                            <MudText Typo="Typo.body2" Color="Color.Warning">Sin Stock</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h5">
                            @(sinStock == 0 ? "0" : sinStock.ToString())
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border-left: 4px solid var(--mud-palette-secondary);">
        <MudText Typo="Typo.h6" Color="Color.Secondary">Top Productos</MudText>
    </MudPaper>

    <MudGrid Spacing="3" Class="mb-6">
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2">
                <MudTable Items="@top5MasValiosos?.OrderByDescending(item => item.Precio)" Hover="true"
                    Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info" Elevation="0">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Euro" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.h6">Top 5 Más Valiosos</MudText>
                        </MudStack>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>SKU</MudTh>
                        <MudTh>
                            <MudTableSortLabel T="string">Precio</MudTableSortLabel>
                        </MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.Id</MudChip>
                        </MudTd>
                        <MudTd DataLabel="SKU">
                            <MudText Typo="Typo.body2">@context.SKU</MudText>
                        </MudTd>
                        <MudTd DataLabel="Precio">
                            <MudText Typo="Typo.body1" Color="Color.Success">
                                <strong>@context.Precio.ToString("N2") €</strong>
                            </MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="2">
                <MudTable Items="@top5MasStock?.OrderByDescending(item => item.StockActual)" Hover="true"
                    Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info" Elevation="0">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Color="Color.Primary" Size="Size.Small" />
                            <MudText Typo="Typo.h6">Top 5 Más Stock</MudText>
                        </MudStack>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>SKU</MudTh>
                        <MudTh>
                            <MudTableSortLabel T="string">Stock</MudTableSortLabel>
                        </MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.Id</MudChip>
                        </MudTd>
                        <MudTd DataLabel="SKU">
                            <MudText Typo="Typo.body2">@context.SKU</MudText>
                        </MudTd>
                        <MudTd DataLabel="Stock">
                            <MudText Typo="Typo.body1" Color="Color.Primary">
                                <strong>@context.StockActual uds</strong>
                            </MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="2">
                <MudTable Items="@top5MenosStock?.OrderBy(item => item.StockActual)" Hover="true"
                    Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info" Elevation="0">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Color="Color.Warning"
                                Size="Size.Small" />
                            <MudText Typo="Typo.h6">Top 5 Menos Stock</MudText>
                        </MudStack>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>SKU</MudTh>
                        <MudTh>
                            <MudTableSortLabel T="string">Stock</MudTableSortLabel>
                        </MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.Id</MudChip>
                        </MudTd>
                        <MudTd DataLabel="SKU">
                            <MudText Typo="Typo.body2">@context.SKU</MudText>
                        </MudTd>
                        <MudTd DataLabel="Stock">
                            <MudText Typo="Typo.body1" Color="Color.Warning">
                                <strong>@context.StockActual uds</strong>
                            </MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code
{
    //Variables KPI's
    private decimal valorTotal = 0;
    private int totalProductos = 0;
    private int stockBajo = 0;
    private decimal precioPromedio = 0;

    //Variables info adicional
    private int totalMovimientosUltimos30 = 0;
    private EntradasVsSalidasDto? entradaVsSalidaUltimos30;
    private PagedResponse<MovimientoPorDiaDto>? movimientoPorDia;
    private int sinStock = 0;

    //Flags
    private bool loading = true;
    private string? error = null;

    //Variables de chart
    private int _index = -1;
    private ChartOptions _options = new ChartOptions
    {
        LineStrokeWidth = 3,
        InterpolationOption = InterpolationOption.NaturalSpline,
        YAxisLines = true,
        YAxisFormat = "N0",
        ChartPalette = new string[] { "#4c96f6" }
    };

    private AxisChartOptions _axisChartOptions = new AxisChartOptions();
    private List<ChartSeries> _series = new List<ChartSeries>();
    private string[] _xAxisLabels = { };


    //Variables de Tablas

    private List<ProductoResponseDto>? top5MasValiosos;
    private List<ProductoResponseDto>? top5MasStock;
    private List<ProductoResponseDto>? top5MenosStock;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            loading = true;

            // Cargar datos de KPIs
            valorTotal = await ProductoStatsService.GetTotalValorInventario();
            totalProductos = await ProductoStatsService.GetTotalProductos();
            stockBajo = await ProductoStatsService.GetProductosBajoStock();
            precioPromedio = await ProductoStatsService.GetPrecioPromedio();

            // Cargar datos de charts
            movimientoPorDia = await MovimientosStatsService.GetMovimientosPorDiaAsync(1, 100);

            _series.Add(new ChartSeries()
            {
                Name = $"Movimientos ({movimientoPorDia.Items.First().Fecha:MMM} - {movimientoPorDia.Items.Last().Fecha:MMM})",
                Data = movimientoPorDia.Items.Select(item => (double)item.TotalMovimientos).ToArray()
            });

            _xAxisLabels = movimientoPorDia.Items.Select(item => item.Fecha.ToString("dd")).ToArray();

            // Opciones de Chart
            _axisChartOptions.MatchBoundsToSize = true;
            _series.ForEach(x => x.ShowDataMarkers = true);

            //Cargar info adicional
            totalMovimientosUltimos30 = await MovimientosStatsService.GetTotalMovimientosUltimos30DiasAsync();
            entradaVsSalidaUltimos30 = await MovimientosStatsService.GetEntradasVsSalidasUltimos30DiasAsync();
            sinStock = await ProductoStatsService.GetProductosSinStock();

            //Cargar datos de Tabla

            top5MasValiosos = await ProductoStatsService.GetTop5ProductosMasValiosos();
            top5MasStock = await ProductoStatsService.GetTop5ProductosMasStock();
            top5MenosStock = await ProductoStatsService.GetTop5ProductosMenorStock();

            loading = false;
        }
        catch (Exception ex)
        {
            error = ex.Message;
            loading = false;
        }
    }
}