@page "/"

@inject IProductoStatsService ProductoStatsService
@inject IProveedorStatsService ProveedorStatsService
@inject IMovimientosStatsService MovimientosStatsService
@inject ICategoriaStatsService CategoriaStatsService


<PageTitle>Home</PageTitle>
<TitleCard Title="Kpi's principales"></TitleCard>
<MudGrid Spacing="2">
    <MudItem xs="3">
        <KpiCard Title="Valor Total Inventario" Value=@($"{valorTotal:N2} €") Icon="@Icons.Material.Filled.AttachMoney"
            IconColor="Color.Success" ValueColor="Color.Success" />
    </MudItem>
    <MudItem xs="3">
        <KpiCard Title="Precio promedio" Value=@($"{precioPromedio:N2} €") Icon="@Icons.Material.Filled.AttachMoney"
            IconColor="Color.Success" ValueColor="Color.Success" />
    </MudItem>
    <MudItem xs="3">
        <KpiCard Title="Total Productos" Value=@totalProductos.ToString("N0") Icon="@Icons.Material.Filled.Inventory"
            IconColor="Color.Primary" ValueColor="Color.Primary" />
    </MudItem>

    <MudItem xs="3">
        <KpiCard Title="Stock Bajo" Value=@(stockBajo == 0 ? "Sin alertas" : stockBajo.ToString())
            Icon="@Icons.Material.Filled.Warning" IconColor="Color.Warning" ValueColor="Color.Warning" />
    </MudItem>
</MudGrid>

<TitleCard Title="Resumen de movimientos mensuales"></TitleCard>
<MudGrid Spacing="2">
    <MudItem xs="9">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Movimientos por Día</MudText>
            <MudChart ChartType="ChartType.Line" ChartSeries="@_series" XAxisLabels="@_xAxisLabels" Width="100%"
                Height="335px" ChartOptions="@_options" AxisChartOptions="@_axisChartOptions" />
        </MudPaper>
    </MudItem>
    <MudItem xs="3">
        <MudStack>
            <KpiCard Title="Últimos 30 dias" Value=@(totalMovimientosUltimos30 == 0 ? "Sin movimientos" :
                                                             $"{totalMovimientosUltimos30.ToString()} movimientos") Icon="@Icons.Material.Filled.Info"
                IconColor="Color.Tertiary" ValueColor="Color.Tertiary" />
            <KpiCard Title="Total entradas" Value=@(entradaVsSalidaUltimos30?.TotalEntradas == 0 ? "Sin entradas" :
                                                            $"{entradaVsSalidaUltimos30?.TotalEntradas.ToString()} entradas") Icon="@Icons.Material.Filled.Info"
                IconColor="Color.Tertiary" ValueColor="Color.Tertiary" />
            <KpiCard Title="Total salidas" Value=@(entradaVsSalidaUltimos30?.TotalSalidas == 0 ? "Sin salidas" :
                                                           $"{entradaVsSalidaUltimos30?.TotalSalidas.ToString()} salidas") Icon="@Icons.Material.Filled.Info"
                IconColor="Color.Tertiary" ValueColor="Color.Tertiary" />
            <KpiCard Title="Sin Stock" Value=@(sinStock == 0 ? "Sin alertas" : sinStock.ToString())
                Icon="@Icons.Material.Filled.Info" IconColor="Color.Tertiary" ValueColor="Color.Tertiary" />
        </MudStack>
    </MudItem>
</MudGrid>

<TitleCard Title="Histórico de Tops de producto"></TitleCard>
<MudGrid Spacing="2" Class="mb-4">
    <MudItem xs="4">
        <MudTable Items="@top5MasValiosos?.OrderByDescending(item => item.Precio)" Hover="true"
            Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Top 5 más valiosos</MudText>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Sku</MudTh>
                <MudTh>Precio</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nr">@context.Id</MudTd>
                <MudTd DataLabel="Sign">@context.SKU</MudTd>
                <MudTd DataLabel="Name">@context.Precio €</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
    <MudItem xs="4">
        <MudTable Items="@top5MasStock?.OrderByDescending(item => item.StockActual)" Hover="true"
            Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Top 5 más Stock</MudText>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Sku</MudTh>
                <MudTh>Stock</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nr">@context.Id</MudTd>
                <MudTd DataLabel="Sign">@context.SKU</MudTd>
                <MudTd DataLabel="Name">@context.StockActual uds</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
    <MudItem xs="4">
        <MudTable Items="@top5MenosStock?.OrderBy(item => item.StockActual)" Hover="true" Breakpoint="Breakpoint.Sm"
            Loading="@loading" LoadingProgressColor="Color.Info">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Top 5 menos Stock</MudText>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Sku</MudTh>
                <MudTh>Stock</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nr">@context.Id</MudTd>
                <MudTd DataLabel="Sign">@context.SKU</MudTd>
                <MudTd DataLabel="Name">@context.StockActual uds</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
</MudGrid>

@code
{
    //Variables KPI's
    private decimal valorTotal = 0;
    private int totalProductos = 0;
    private int stockBajo = 0;
    private decimal precioPromedio = 0;

    //Variables info adicional
    private int totalMovimientosUltimos30 = 0;
    private EntradasVsSalidasDto? entradaVsSalidaUltimos30;
    private PagedResponse<MovimientoPorDiaDto>? movimientoPorDia;
    private int sinStock = 0;

    //Flags
    private bool loading = true;
    private string? error = null;

    //Variables de chart
    private int _index = -1;
    private ChartOptions _options = new ChartOptions
    {
        LineStrokeWidth = 3,
        InterpolationOption = InterpolationOption.NaturalSpline,
        YAxisLines = true,
        YAxisFormat = "N0",
        ChartPalette = new string[] { "#4c96f6" }
    };

    private AxisChartOptions _axisChartOptions = new AxisChartOptions();
    private List<ChartSeries> _series = new List<ChartSeries>();
    private string[] _xAxisLabels = { };


    //Variables de Tablas

    private List<ProductoResponseDto>? top5MasValiosos;
    private List<ProductoResponseDto>? top5MasStock;
    private List<ProductoResponseDto>? top5MenosStock;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            loading = true;

            // Cargar datos de KPIs
            valorTotal = await ProductoStatsService.GetTotalValorInventario();
            totalProductos = await ProductoStatsService.GetTotalProductos();
            stockBajo = await ProductoStatsService.GetProductosBajoStock();
            precioPromedio = await ProductoStatsService.GetPrecioPromedio();

            // Cargar datos de charts
            movimientoPorDia = await MovimientosStatsService.GetMovimientosPorDiaAsync(1, 100);

            _series.Add(new ChartSeries()
            {
                Name = $"Movimientos ({movimientoPorDia.Items.First().Fecha:MMM} - {movimientoPorDia.Items.Last().Fecha:MMM})",
                Data = movimientoPorDia.Items.Select(item => (double)item.TotalMovimientos).ToArray()
            });

            _xAxisLabels = movimientoPorDia.Items.Select(item => item.Fecha.ToString("dd")).ToArray();

            // Opciones de Chart
            _axisChartOptions.MatchBoundsToSize = true;
            _series.ForEach(x => x.ShowDataMarkers = true);

            //Cargar info adicional
            totalMovimientosUltimos30 = await MovimientosStatsService.GetTotalMovimientosUltimos30DiasAsync();
            entradaVsSalidaUltimos30 = await MovimientosStatsService.GetEntradasVsSalidasUltimos30DiasAsync();
            sinStock = await ProductoStatsService.GetProductosSinStock();

            //Cargar datos de Tabla

            top5MasValiosos = await ProductoStatsService.GetTop5ProductosMasValiosos();
            top5MasStock = await ProductoStatsService.GetTop5ProductosMasStock();
            top5MenosStock = await ProductoStatsService.GetTop5ProductosMenorStock();

            loading = false;
        }
        catch (Exception ex)
        {
            error = ex.Message;
            loading = false;
        }
    }
}