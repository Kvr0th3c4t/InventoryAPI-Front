@page "/movimientos-crear"
@using InventoryAPI_UI.Enums

@inject IMovimientoService MovimientoService
@inject IProveedorService ProveedorService
@inject IProductoService ProductoService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudPaper Elevation="2" Class="pa-6">
    <MudText Typo="Typo.h5" Class="mb-4">Crear Categoria</MudText>

    <MudForm @ref="_form" Model="@createMovimientoDto">
        <MudGrid Spacing="3">

            <MudItem xs="12">
                <MudTextField @bind-Value="createMovimientoDto.ProductoId" Label="Id del producto"
                    Variant="Variant.Outlined" Required="true" RequiredError="El Id del producto es obligatorio" />
            </MudItem>

            <MudItem xs="12">
                <MudSelect @bind-Value="proveedorSeleccionado" Label="Proveedor" Variant="Variant.Outlined"
                    Required="true" T="int?" Placeholder="Selecciona un proveedor">
                    @foreach (var prov in proveedores?.Items ?? new())
                    {
                        <MudSelectItem T="int?" Value="@((int?)prov.Id)">
                            @prov.Nombre
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudSelect @bind-Value="createMovimientoDto.Tipo" Label="Tipo de movimiento" Variant="Variant.Outlined"
                    Required="true" T="TipoMovimiento">
                    @foreach (TipoMovimiento tipo in Enum.GetValues(typeof(TipoMovimiento)))
                    {
                        <MudSelectItem T="TipoMovimiento" Value="@tipo">
                            @tipo.ToString()
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="createMovimientoDto.Cantidad" Label="Cantidad" Variant="Variant.Outlined">
                </MudTextField>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="createMovimientoDto.Razon" Label="Razón" Variant="Variant.Outlined">
                </MudTextField>
            </MudItem>

        </MudGrid>

        <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Class="mt-6">
            <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Outlined" Color="Color.Default"
                Href="/movimientos-lista">
                Volver
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CreateProductoAsync"
                StartIcon="@Icons.Material.Filled.Add">
                Crear movimiento
            </MudButton>
        </MudStack>
    </MudForm>
</MudPaper>

@code
{
    private MudForm? _form;
    private CreateMovimientoDto createMovimientoDto = new();
    private PagedResponse<ProveedorResponseDto> proveedores = new()
    {
        Items = new List<ProveedorResponseDto>()
    };
    private bool loading = true;
    private int? proveedorSeleccionado;
    protected override async Task OnInitializedAsync()
    {
        try
        {
            loading = true;
            proveedores = await ProveedorService.GetAllProveedoresAsync(1, 100);
            loading = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar: {ex.Message}", Severity.Error);
            loading = false;
        }
    }
    private async Task CreateProductoAsync()
    {
        try
        {
            createMovimientoDto.ProveedorId = proveedorSeleccionado;
            await MovimientoService.AddMovimientoAsync(createMovimientoDto);

            Snackbar.Add("✅ Producto creado correctamente", Severity.Success);
            NavigationManager.NavigateTo("/productos-lista");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error: {ex.Message}", Severity.Error);
        }
    }
}