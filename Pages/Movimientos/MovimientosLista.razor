@page "/movimientos-lista"

@inject IMovimientoService MovimientoService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Listado - Movimientos</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" Size="Size.Small" />
                Filtros
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                Href="/movimientos-crear">
                Nuevo Movimiento
            </MudButton>
        </MudStack>

        <MudGrid Spacing="3">
            <MudItem xs="12" sm="6" md="2">
                <MudDatePicker Label="Fecha desde" @bind-Date="fechaDesdeFilter" DateFormat="yyyy-MM-dd"
                    Variant="Variant.Outlined" Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
            </MudItem>

            <MudItem xs="12" sm="6" md="2">
                <MudDatePicker Label="Fecha hasta" @bind-Date="fechaHastaFilter" DateFormat="yyyy-MM-dd"
                    Variant="Variant.Outlined" Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
            </MudItem>

            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="TipoMovimiento?" Label="Tipo de movimiento" @bind-Value="tipoFilter"
                    Variant="Variant.Outlined" Clearable="true" Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.SwapVert">
                    <MudSelectItem T="TipoMovimiento?" Value="@((TipoMovimiento?)null)">Todos</MudSelectItem>
                    <MudSelectItem T="TipoMovimiento?" Value="TipoMovimiento.Entrada">Entrada</MudSelectItem>
                    <MudSelectItem T="TipoMovimiento?" Value="TipoMovimiento.Salida">Salida</MudSelectItem>
                    <MudSelectItem T="TipoMovimiento?" Value="TipoMovimiento.AjustePositivo">Ajuste Positivo</MudSelectItem>
                    <MudSelectItem T="TipoMovimiento?" Value="TipoMovimiento.AjusteNegativo">Ajuste Negativo</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="2">
                <MudTextField T="int?" @bind-Value="productoIdFilter" Label="ID Producto" Placeholder="Ej: 1"
                    Variant="Variant.Outlined" InputType="InputType.Number" Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Tag" />
            </MudItem>

            <MudItem xs="12" md="4" Class="d-flex align-center justify-end">
                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Medium">
                    <MudButton Color="Color.Default" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                        Limpiar
                    </MudButton>
                    <MudButton Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.Check">
                        Aplicar
                    </MudButton>
                </MudButtonGroup>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Elevation="2">
        <MudDataGrid T="MovimientoResponseDto" @ref="dataGrid" ServerData="@LoadServerData" RowsPerPage="10" Hover="true"
            Striped="true" SortMode="SortMode.Multiple" Elevation="0">

            <Columns>
                <PropertyColumn Property="x => x.Id" Title="ID" Sortable="true">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Variant="Variant.Text">@context.Item.Id</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.ProductoNombre" Title="Producto" Sortable="true">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Color="Color.Primary">@context.Item.ProductoNombre</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.ProveedorNombre" Title="Proveedor" Sortable="true">
                    <CellTemplate>
                        @if (!string.IsNullOrEmpty(context.Item.ProveedorNombre))
                        {
                            <MudChip Size="Size.Small" Color="Color.Tertiary">@context.Item.ProveedorNombre</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Sin proveedor</MudText>
                        }
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Fecha" Title="Fecha" Sortable="true">
                    <CellTemplate>
                        <MudText Typo="Typo.body2">
                            @context.Item.Fecha.ToString("dd/MM/yyyy HH:mm")
                        </MudText>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Tipo" Title="Tipo" Sortable="true">
                    <CellTemplate>
                        @{
                            var (colorTipo, iconoTipo) = context.Item.Tipo switch
                            {
                                TipoMovimiento.Entrada => (Color.Success, Icons.Material.Filled.ArrowDownward),
                                TipoMovimiento.Salida => (Color.Error, Icons.Material.Filled.ArrowUpward),
                                TipoMovimiento.AjustePositivo => (Color.Info, Icons.Material.Filled.Add),
                                TipoMovimiento.AjusteNegativo => (Color.Warning, Icons.Material.Filled.Remove),
                                _ => (Color.Default, Icons.Material.Filled.SwapVert)
                            };
                        }
                        <MudChip Size="Size.Small" Color="@colorTipo" Icon="@iconoTipo">
                            @context.Item.Tipo.ToString()
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Cantidad" Title="Cantidad" Sortable="true">
                    <CellTemplate>
                        @{
                            var esPositivo = context.Item.Tipo == TipoMovimiento.Entrada ||
                                context.Item.Tipo == TipoMovimiento.AjustePositivo;
                            var colorCantidad = esPositivo ? Color.Success : Color.Error;
                            var signo = esPositivo ? "+" : "-";
                        }
                        <MudChip Size="Size.Small" Color="@colorCantidad" Variant="Variant.Text">
                            @signo@context.Item.Cantidad uds
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Razon" Title="Razón" Sortable="false">
                    <CellTemplate>
                        @if (!string.IsNullOrEmpty(context.Item.Razon))
                        {
                            <MudText Typo="Typo.body2">@context.Item.Razon</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Sin razón especificada</MudText>
                        }
                    </CellTemplate>
                </PropertyColumn>

            </Columns>

            <PagerContent>
                <MudDataGridPager T="MovimientoResponseDto" />
            </PagerContent>

            <LoadingContent>
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Class="ma-4" />
            </LoadingContent>

            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        No se encontraron movimientos con los filtros actuales
                    </MudText>
                </MudStack>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    private MudDataGrid<MovimientoResponseDto>? dataGrid;

    private DateTime? fechaDesdeFilter;
    private DateTime? fechaHastaFilter;
    private TipoMovimiento? tipoFilter;
    private int? productoIdFilter;

    private async Task<GridData<MovimientoResponseDto>> LoadServerData(GridState<MovimientoResponseDto> state)
    {
        try
        {
            string? orderBy = null;
            string? order = null;

            if (state.SortDefinitions?.Count > 0)
            {
                var sortDefinition = state.SortDefinitions.First();

                orderBy = sortDefinition.SortBy switch
                {
                    "Id" => "id",
                    "ProductoNombre" => "productoNombre",
                    "ProveedorNombre" => "proveedorNombre",
                    "Fecha" => "fecha",
                    "Tipo" => "tipo",
                    "Cantidad" => "cantidad",
                    _ => null
                };

                order = sortDefinition.Descending ? "desc" : "asc";
            }

            DateTimeOffset? fechaDesdeParam = fechaDesdeFilter.HasValue
                ? new DateTimeOffset(fechaDesdeFilter.Value)
                : null;

            DateTimeOffset? fechaHastaParam = fechaHastaFilter.HasValue
                ? new DateTimeOffset(fechaHastaFilter.Value.AddDays(1).AddTicks(-1))
                : null;

            var response = await MovimientoService.GetAllMovimientosAsync(
                fechaDesde: fechaDesdeParam,
                fechaHasta: fechaHastaParam,
                tipo: tipoFilter,
                productoId: productoIdFilter,
                orderBy: orderBy ?? "fecha",
                order: order ?? "desc",
                pageNumber: state.Page + 1,
                pageSize: state.PageSize
            );

            if (response == null)
            {
                return new GridData<MovimientoResponseDto>
                {
                    Items = new List<MovimientoResponseDto>(),
                    TotalItems = 0
                };
            }

            return new GridData<MovimientoResponseDto>
            {
                Items = response.Items ?? new List<MovimientoResponseDto>(),
                TotalItems = response.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cargando movimientos: {ex.Message}", Severity.Error);
            return new GridData<MovimientoResponseDto>
            {
                Items = new List<MovimientoResponseDto>(),
                TotalItems = 0
            };
        }
    }

    private async Task ApplyFilters()
    {
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
            Snackbar.Add("Filtros aplicados", Severity.Info);
        }
    }

    private async Task ClearFilters()
    {
        fechaDesdeFilter = null;
        fechaHastaFilter = null;
        tipoFilter = null;
        productoIdFilter = null;

        await ApplyFilters();
        Snackbar.Add("Filtros reseteados", Severity.Info);
    }
}