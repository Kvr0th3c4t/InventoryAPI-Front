@page "/productos-lista"
@attribute [AuthorizeAttribute]
@inject IDialogService DialogService
@inject IProductoService ProductoService
@inject ICategoriaService CategoriaService
@inject IProveedorService ProveedorService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Listado - Productos</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" Size="Size.Small" />
                Filtros
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                Href="/productos-crear">
                Nuevo Producto
            </MudButton>
        </MudStack>

        <MudGrid Spacing="3">
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="searchFilter" Label="Buscar" Placeholder="Nombre de producto..."
                    Variant="Variant.Outlined" Adornment="@Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Search" Clearable="true"
                    OnKeyDown="@(async (e) => { if (e.Key == "Enter") await ApplyFilters(); })" />
            </MudItem>

            <MudItem xs="12" sm="6" md="2">
                <MudTextField T="decimal?" @bind-Value="precioMinFilter" Label="Precio mínimo"
                    Variant="Variant.Outlined" InputType="InputType.Number" Step="0.01" Adornment="Adornment.Start"
                    AdornmentText="€" />
            </MudItem>

            <MudItem xs="12" sm="6" md="2">
                <MudTextField T="decimal?" @bind-Value="precioMaxFilter" Label="Precio máximo"
                    Variant="Variant.Outlined" InputType="InputType.Number" Step="0.01" Adornment="Adornment.Start"
                    AdornmentText="€" />
            </MudItem>

            <MudItem xs="12" sm="6" md="2" Class="d-flex align-center">
                <MudCheckBox @bind-Value="stockBajoFilter" Label="Stock bajo" Color="Color.Warning" />
            </MudItem>

            <MudItem xs="12" md="3" Class="d-flex align-center justify-end">
                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Medium">
                    <MudButton Color="Color.Default" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                        Limpiar
                    </MudButton>
                    <MudButton Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.Check">
                        Aplicar
                    </MudButton>
                </MudButtonGroup>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Elevation="2">
        <MudDataGrid T="ProductoResponseDto" @ref="dataGrid" ServerData="@LoadServerData" RowsPerPage="10" Hover="true"
            Striped="true" SortMode="SortMode.Multiple" Elevation="0">

            <Columns>
                <PropertyColumn Property="x => x.Id" Title="ID" Sortable="false">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Variant="Variant.Text">@context.Item.Id</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Nombre" Title="Nombre" Sortable="true" />

                <PropertyColumn Property="x => x.SKU" Title="SKU" Sortable="false">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Color="Color.Default">@context.Item.SKU</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.CategoriaNombre" Title="Categoría" Sortable="true">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Color="Color.Primary">@context.Item.CategoriaNombre</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.StockActual" Title="Stock" Sortable="true">
                    <CellTemplate>
                        <MudChip Size="Size.Small"
                            Color="@(context.Item.StockActual == 0 ? Color.Error : context.Item.StockActual < 10 ? Color.Warning : Color.Success)">
                            @context.Item.StockActual uds
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Precio" Title="Precio" Sortable="true">
                    <CellTemplate>
                        <MudText Typo="Typo.body1" Style="font-weight: 500;">
                            @context.Item.Precio.ToString("C2")
                        </MudText>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.ProveedorNombre" Title="Proveedor" Sortable="true">
                    <CellTemplate>
                        @if (!string.IsNullOrEmpty(context.Item.ProveedorNombre))
                        {
                            <MudChip Size="Size.Small" Color="Color.Tertiary">@context.Item.ProveedorNombre</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Sin proveedor</MudText>
                        }
                    </CellTemplate>
                </PropertyColumn>

                <TemplateColumn Title="Acciones" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1">
                            <MudTooltip Text="Editar">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning"
                                    Size="Size.Small" OnClick="@(() => EditProduct(context.Item.Id))" />
                            </MudTooltip>
                            <MudTooltip Text="Ver detalles">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info"
                                    Size="Size.Small" OnClick="@(() => ViewProduct(context.Item.Id))" />
                            </MudTooltip>
                            <MudTooltip Text="Eliminar">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                    Size="Size.Small" OnClick="@(() => DeleteProducto(context.Item.Id))" />
                            </MudTooltip>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>

            </Columns>

            <PagerContent>
                <MudDataGridPager T="ProductoResponseDto" />
            </PagerContent>

            <LoadingContent>
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Class="ma-4" />
            </LoadingContent>

            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        No se encontraron productos con los filtros actuales
                    </MudText>
                </MudStack>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    private MudDataGrid<ProductoResponseDto>? dataGrid;

    private string? searchFilter;
    private int? categoriaIdFilter;
    private int? proveedorIdFilter;
    private decimal? precioMinFilter;
    private decimal? precioMaxFilter;
    private bool? stockBajoFilter;

    private async Task<GridData<ProductoResponseDto>> LoadServerData(GridState<ProductoResponseDto> state)
    {
        try
        {
            string? orderBy = null;
            string? order = null;

            if (state.SortDefinitions?.Count > 0)
            {
                var sortDefinition = state.SortDefinitions.First();

                orderBy = sortDefinition.SortBy switch
                {
                    "Id" => "id",
                    "Nombre" => "nombre",
                    "CategoriaNombre" => "categoria",
                    "StockActual" => "stock",
                    "Precio" => "precio",
                    "ProveedorNombre" => "proveedor",
                    _ => null
                };

                order = sortDefinition.Descending ? "desc" : "asc";
            }

            var response = await ProductoService.GetAllProductosAsync(
            pageNumber: state.Page + 1,
            pageSize: state.PageSize,
            search: string.IsNullOrWhiteSpace(searchFilter) ? null : searchFilter,
            categoriaId: categoriaIdFilter,
            proveedorId: proveedorIdFilter,
            precioMin: precioMinFilter,
            precioMax: precioMaxFilter,
            stockBajo: stockBajoFilter,
            orderBy: orderBy,
            order: order
            );

            if (response == null)
            {
                return new GridData<ProductoResponseDto>
                {
                    Items = new List<ProductoResponseDto>(),
                    TotalItems = 0
                };
            }

            return new GridData<ProductoResponseDto>
            {
                Items = response.Items ?? new List<ProductoResponseDto>(),
                TotalItems = response.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cargando productos: {ex.Message}", Severity.Error);
            return new GridData<ProductoResponseDto>
            {
                Items = new List<ProductoResponseDto>(),
                TotalItems = 0
            };
        }
    }

    private async Task ApplyFilters()
    {
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
            Snackbar.Add("Filtros aplicados", Severity.Info);
        }
    }

    private async Task ClearFilters()
    {
        searchFilter = null;
        categoriaIdFilter = null;
        proveedorIdFilter = null;
        precioMinFilter = null;
        precioMaxFilter = null;
        stockBajoFilter = null;

        await ApplyFilters();
        Snackbar.Add("Filtros reseteados", Severity.Info);
    }

    private void EditProduct(int id) => NavigationManager.NavigateTo($"/productos-editar/{id}");

    private void ViewProduct(int id) => NavigationManager.NavigateTo($"/productos-detalle/{id}");


    private async Task DeleteProducto(int id)
    {
        try
        {
            await ProductoService.DeleteProductoAsync(id);
            await dataGrid!.ReloadServerData();
            Snackbar.Add("✅ Producto eliminado correctamente", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error: {ex.Message}", Severity.Error);
        }
    }
}