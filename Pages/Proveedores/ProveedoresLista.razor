@page "/proveedores-lista"
@attribute [AuthorizeAttribute]
@inject IProveedorService ProveedorService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Listado - Proveedores</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" Size="Size.Small" />
                Proveedores
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                Href="/proveedores-crear">
                Nuevo Proveedor
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudPaper Elevation="2">
        <MudDataGrid T="ProveedorResponseDto" @ref="dataGrid" ServerData="@LoadServerData" RowsPerPage="10" Hover="true"
            Striped="true" SortMode="SortMode.Multiple" Elevation="0">

            <Columns>
                <PropertyColumn Property="x => x.Id" Title="ID" Sortable="false">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Variant="Variant.Text">@context.Item.Id</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Nombre" Title="Nombre" Sortable="true">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Color="Color.Tertiary">@context.Item.Nombre</MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Email" Title="Email" Sortable="false">
                    <CellTemplate>
                        @if (!string.IsNullOrEmpty(context.Item.Email))
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Primary" />
                                <MudText Typo="Typo.body2">@context.Item.Email</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Sin email</MudText>
                        }
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Telefono" Title="Contacto" Sortable="false">
                    <CellTemplate>
                        @if (!string.IsNullOrEmpty(context.Item.Telefono))
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.body2">@context.Item.Telefono</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Sin teléfono</MudText>
                        }
                    </CellTemplate>
                </PropertyColumn>

                <TemplateColumn Title="Acciones" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1">
                            <MudTooltip Text="Editar">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning"
                                    Size="Size.Small" OnClick="@(() => EditProveedor(context.Item.Id))" />
                            </MudTooltip>
                            <MudTooltip Text="Eliminar">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                    Size="Size.Small" OnClick="@(() => DeleteProveedor(context.Item.Id))" />
                            </MudTooltip>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>

            </Columns>

            <PagerContent>
                <MudDataGridPager T="ProveedorResponseDto" />
            </PagerContent>

            <LoadingContent>
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Class="ma-4" />
            </LoadingContent>

            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        No se encontraron proveedores
                    </MudText>
                </MudStack>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    private MudDataGrid<ProveedorResponseDto>? dataGrid;

    private async Task<GridData<ProveedorResponseDto>> LoadServerData(GridState<ProveedorResponseDto> state)
    {
        try
        {
            var response = await ProveedorService.GetAllProveedoresAsync(
                pageNumber: state.Page + 1,
                pageSize: state.PageSize
            );

            if (response == null)
            {
                return new GridData<ProveedorResponseDto>
                {
                    Items = new List<ProveedorResponseDto>(),
                    TotalItems = 0
                };
            }

            return new GridData<ProveedorResponseDto>
            {
                Items = response.Items ?? new List<ProveedorResponseDto>(),
                TotalItems = response.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cargando proveedores: {ex.Message}", Severity.Error);
            return new GridData<ProveedorResponseDto>
            {
                Items = new List<ProveedorResponseDto>(),
                TotalItems = 0
            };
        }
    }

    private void EditProveedor(int id) => NavigationManager.NavigateTo($"/proveedores-editar/{id}");

    private async Task DeleteProveedor(int id)
    {
        try
        {
            await ProveedorService.DeleteProveedorAsync(id);
            await dataGrid!.ReloadServerData();
            Snackbar.Add("✅ Proveedor eliminado correctamente", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error: {ex.Message}", Severity.Error);
        }
    }
}